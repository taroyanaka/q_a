.<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>p2</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.4.0/firebase-auth.js"></script>
    </head>
<body>
    <div id="app">
        <div>
            <h3>All Links</h3>
            <ul>
                <li v-for="link in allLinks" :key="link.id">
                    {{ link.data_json_str }} (ID: {{ link.id }})
                </li>
            </ul>
        </div>
        <div>
            <h3>Your Data</h3>
            <button @click="fetchUserData">Fetch User Data</button>
            <ul>
                <li v-for="link in userLinks" :key="link.id">
                    {{ link.data_json_str }} (ID: {{ link.id }})
                    <button @click="deleteLink(link.id)">Delete</button>
                </li>
            </ul>
        </div>
        <div class="top-button">
            <button @click="replaceUrlToLocalhost">Replace URL to Localhost</button>
        </div>

        <h1>{{ uid || 'Your UID' }}</h1>
        <h2>{{ loginResult }}</h2>

        <input type="button" v-if="!loggedIn" @click="googleSignIn" value="Google Login">
        
        <input type="button" v-if="loggedIn" @click="googleSignOut" value="Logout">

        <div v-if="loggedIn">
            <form @submit.prevent="validateAndSubmit">
                <label>
                    Data 1:
                    <textarea v-model="data1" placeholder="Enter data1 (e.g., 縄文時代\n弥生時代)" required></textarea>
                </label>
                <label>
                    Data 2:
                    <textarea v-model="data2" placeholder="Enter data2 (e.g., 日本の先史時代。\n日本の稲作農耕文化が発展した時代。)" required></textarea>
                </label>
                <button type="submit">Submit</button>
                <div v-if="errorMessage" class="error">{{ errorMessage }}</div>
                <div v-if="successMessage" class="success">{{ successMessage }}</div>
            </form>
        </div>
    </div>

<script>
    // Firebase の設定
    const firebaseConfig = {
      apiKey: "AIzaSyBcOlIDP2KWbJuKM0WeMHNp-WvjTVfLt9Y",
      authDomain: "p2auth-ea50a.firebaseapp.com",
      projectId: "p2auth-ea50a",
      storageBucket: "p2auth-ea50a.appspot.com",
      messagingSenderId: "796225429484",
      appId: "1:796225429484:web:ece56ef2fc0be28cd6eac9"
    };

    // Firebase 初期化
    firebase.initializeApp(firebaseConfig);




    const app = Vue.createApp({
        data() {
            return {
                username: '',
                uid: null,
                loggedIn: false,
                loginResult: '',
                data1: '',
                data2: '',
                errorMessage: '',
                successMessage: '',
                user: null,
                password: '',
                enpnt: 'https://cotton-concrete-catsup.glitch.me',
                userLinks: [],
                allLinks: []
            };
        },
        mounted() {
          
            const storedUsername = localStorage.getItem('username');
            const storedPassword = localStorage.getItem('password');
            if (storedUsername && storedPassword) {
                this.username = storedUsername;
                this.password = storedPassword;
                this.loggedIn = true;
                this.fetchUserData();
            }
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    this.user = user;
                    this.uid = user.uid;
                    this.loggedIn = true;
                    this.fetchUserData();
                }
            });
        },
        methods: {
            async fetchUserData() {
                try {
                    const response = await fetch(`${this.enpnt}/read_all`);
                    if (!response.ok) {
                        throw new Error(`Failed to fetch user data: ${response.status} ${response.statusText}`);
                    }
                    const result = await response.json();
                    this.allLinks = result.message;
                    if (this.loggedIn && this.uid) {
                      console.log(1);
                        this.userLinks = this.allLinks.filter(link => {
                                                console.log( link.username);
                      console.log(this.username);

                          return link.username === this.username});
                    }
                } catch (error) {
                    console.error('Error fetching user data:', error);
                    alert(`Error fetching user data: ${error.message}`);
                }
            },
            async deleteLink(id) {
                try {
                    const response = await fetch(`${this.enpnt}/delete_link`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            id: id,
                            name: this.uid,
                            password: this.password
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`Failed to delete link: ${response.status} ${response.statusText}`);
                    }

                    const result = await response.json();
                    alert(`Link deleted successfully: ${result.message}`);
                    this.fetchUserData();
                } catch (error) {
                    console.error('Error deleting link:', error);
                    alert(`Error deleting link: ${error.message}`);
                }
            },
            async validateAndSubmit() {
                this.errorMessage = '';
                this.successMessage = '';

                if (!this.data1.trim() || !this.data2.trim()) {
                    this.errorMessage = 'Data1 and Data2 cannot be empty';
                    return;
                }

                try {
                    const dataJsonStr = JSON.stringify({ data1: this.data1, data2: this.data2 });

                    const res = await fetch(`${this.enpnt}/insert_link`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            data_type: 'q_a',
                            data_json_str: dataJsonStr,
                            link: '',
                            tags: [],
                            likes: [],
                            comments_and_replies: [],
                            name: this.uid,
                            password: this.password
                        })
                    });

                    const result = await res.json();

                    if (res.ok) {
                        this.successMessage = `Success: ${JSON.stringify(result)}`;
                    } else {
                        this.errorMessage = `Error: ${result.message}`;
                    }
                } catch (error) {
                    console.error('Error:', error);
                    this.errorMessage = `Error: ${error.message}`;
                }
            },
            async googleSignIn() {
                try {
                    const result = await firebase.auth().signInWithPopup(new firebase.auth.GoogleAuthProvider());
                    const currentUser = result.user;
                    if (!currentUser) {
                        throw new Error("Firebaseログインに失敗し、ユーザーが取得できませんでした。");
                    }
                    this.user = currentUser;
                    this.uid = currentUser.uid;
                    this.loggedIn = true;
                    this.loginResult = 'Login success';

                    const p2LoginUrl = `${this.enpnt}/p2_login?uid=${encodeURIComponent(currentUser.uid)}`;
                    const response = await fetch(p2LoginUrl, { method: 'GET' });
                    if (!response.ok) {
                        throw new Error(`p2_login error: ${response.status} ${response.statusText}`);
                    }
                    const data = await response.json();
                    this.username = data.message.id;
                    localStorage.setItem('username', data.message.id);
                    localStorage.setItem('password', data.message.password);
                    this.password = data.message.password;
                    alert(`p2_login成功: id=${data.message.id}, password=${data.message.password}`);
                    this.fetchUserData();
                } catch (err) {
                    console.error("ログイン or p2_login失敗:", err);
                    alert(`ログイン失敗: ${err.message}`);
                }
            },
            async googleSignOut() {
                try {
                    await firebase.auth().signOut();
                    this.user = null;
                    this.uid = null;
                    this.loggedIn = false;
                    this.loginResult = 'Signed out successfully';
                    alert("ログアウト完了");
                } catch (err) {
                    console.error("ログアウト失敗:", err);
                    alert(`ログアウト失敗: ${err.message}`);
                }
            },
            replaceUrlToLocalhost() {
                window.location.replace('http://localhost:3000/Users/taroyanaka/Desktop/program/q_a/insert_link.html');
            }
        }
    }).mount('#app');

    const to_ary = (obj) => JSON.parse(JSON.stringify(obj));
</script>
</body>
</html>
