<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>p2</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.4.0/firebase-auth.js"></script>
</head>
<body>
    <div id="app">
        <div style="margin-bottom: 20px;">
            <a href="./b_p.html" target="_blank" style="text-decoration: none;">
                <button>学習モード</button>
            </a>
            <input type="button" @click="replaceUrlToLocalhost" value="replaceUrlToLocalhost">
        </div>

        <h1>{{ uid || 'your uid' }}</h1>
        <h2>{{ loginResult }}</h2>

        <input type="button" v-if="!loggedIn" @click="googleLogin" value="googleLogin">
        <input type="button" v-if="!loggedIn" @click="googleSignUp" value="googleSignUp">
        <input type="button" v-if="loggedIn" @click="signOut" value="logout">

        <div v-if="loggedIn" style="margin-top: 20px;">
            <form @submit.prevent="submitData">
                <label>
                    Data 1:
                    <textarea v-model="data1" placeholder="Enter data1 (e.g., 縄文時代\n弥生時代)" required></textarea>
                </label>
                <label>
                    Data 2:
                    <textarea v-model="data2" placeholder="Enter data2 (e.g., 日本の先史時代。\n日本の稲作農耕文化が発展した時代。)" required></textarea>
                </label>
                <button type="submit">Submit</button>
            </form>
            <div style="margin-top: 20px;">{{ response }}</div>
        </div>
    </div>

    <script>
        const { createApp, ref } = Vue;

        const firebaseConfig = {
            apiKey: "AIzaSyBcOlIDP2KWbJuKM0WeMHNp-WvjTVfLt9Y",
            authDomain: "p2auth-ea50a.firebaseapp.com",
            projectId: "p2auth-ea50a",
            storageBucket: "p2auth-ea50a.appspot.com",
            messagingSenderId: "796225429484",
            appId: "1:796225429484:web:ece56ef2fc0be28cd6eac9"
        };

        firebase.initializeApp(firebaseConfig);
        const google = new firebase.auth.GoogleAuthProvider();

        function toAry(i) {
            return JSON.parse(JSON.stringify(i));
        }

        const app = createApp({
            setup() {
                const endpoint = ref('https://cotton-concrete-catsup.glitch.me');
                const uid = ref(null);
                const loggedIn = ref(false);
                const loginResult = ref('');
                const data1 = ref('');
                const data2 = ref('');
                const response = ref('');
                const id = ref('');
                const password = ref('');

                const checkLogin = () => {
                    firebase.auth().onAuthStateChanged(async user => {
                        if (user) {
                            uid.value = user.uid;
                            loggedIn.value = true;
                            loginResult.value = 'Login success';

                            // Fetch ID and password
                            try {
                                const res = await fetch(`${endpoint.value}/p2_login?uid=${uid.value}`);
                                const result = await res.json();
                                if (res.ok) {
                                    id.value = result.message.id;
                                    password.value = result.message.password;
                                    console.log('ID:', id.value, 'Password:', password.value);
                                } else {
                                    console.error('Failed to fetch ID and password:', result.message);
                                }
                            } catch (error) {
                                console.error('Error fetching ID and password:', error);
                            }
                        } else {
                            uid.value = null;
                            loggedIn.value = false;
                            loginResult.value = 'Not logged in yet';
                        }
                    });
                };

                const googleLogin = () => {
                    firebase.auth().signInWithRedirect(google);
                };

                const googleSignUp = () => {
                    firebase.auth().signInWithRedirect(google);
                };

                const signOut = () => {
                    firebase.auth().signOut().then(() => {
                        loginResult.value = 'Signed out successfully';
                        response.value = '';
                        id.value = '';
                        password.value = '';
                    }).catch(error => {
                        console.error('Sign-out error:', error);
                        loginResult.value = 'Error signing out';
                    });
                };

                const submitData = async () => {
                    if (!data1.value || !data2.value) {
                        alert('Please fill out both data1 and data2 fields.');
                        return;
                    }

                    if (!id.value || !password.value) {
                        alert('ID and password are required to submit data. Please log in again.');
                        return;
                    }

                    try {
                        const dataJsonStr = JSON.stringify({ data1: data1.value, data2: data2.value });

                        const res = await fetch(`${endpoint.value}/insert_link`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                data_type: 'q_a',
                                data_json_str: dataJsonStr,
                                link: '',
                                tags: JSON.stringify([]),
                                likes: JSON.stringify([]),
                                comments_and_replies: JSON.stringify([]),
                                name: id.value, // Include ID in the request body
                                password: password.value // Include password in the request body
                            })
                        });

                        const result = await res.json();

                        if (res.ok) {
                            response.value = `Success: ${JSON.stringify(result)}`;
                        } else {
                            response.value = `Error: ${result.message}`;
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        response.value = `Error: ${error.message}`;
                    }
                };

                const replaceUrlToLocalhost = () => {
                    window.location.replace('http://localhost:3000/p2.html');
                };

                checkLogin();

                return {
                    endpoint,
                    uid,
                    loggedIn,
                    loginResult,
                    data1,
                    data2,
                    response,
                    id,
                    password,
                    googleLogin,
                    googleSignUp,
                    signOut,
                    submitData,
                    replaceUrlToLocalhost
                };
            }
        });

        window.myApp = app.mount('#app');
    </script>
</body>
</html>
